"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var LoaderKey,tslib=require("tslib"),FontFaceObserver=require("fontfaceobserver-es");!function(e){e.Json="Json",e.ArrayBuffer="ArrayBuffer",e.Blob="Blob",e.FormData="FormData",e.Text="Text",e.Image="Image",e.Video="Video",e.Audio="Audio",e.Xml="Xml",e.Font="Font"}(LoaderKey=LoaderKey||{});var isSafari=navigator&&-1<navigator.userAgent.indexOf("Safari"),AsyncPreloader=function(){function o(){var e=this;this.items=new Map,this.defaultBodyMethod="blob",this.defaultLoader=LoaderKey.Text,this.loadItems=function(t){return tslib.__awaiter(e,void 0,void 0,function(){return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,Promise.all(t.map(this.loadItem))];case 1:return[2,e.sent()]}})})},this.loadItem=function(n){return tslib.__awaiter(e,void 0,void 0,function(){var t,r;return tslib.__generator(this,function(e){switch(e.label){case 0:return t=o.getFileExtension(n.src),[4,this["load"+(n.loader||o.getLoaderKey(t))](n)];case 1:return r=e.sent(),this.items.set(n.id||n.src,r),[2,r]}})})},this.loadManifest=function(n,i){return void 0===i&&(i="items"),tslib.__awaiter(e,void 0,void 0,function(){var t,r;return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,this.loadJson({src:n})];case 1:return t=e.sent(),r=o.getProp(t,i),[4,this.loadItems(r)];case 2:return[2,e.sent()]}})})},this.loadText=function(t){return tslib.__awaiter(e,void 0,void 0,function(){return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,o.fetchItem(t)];case 1:return[4,e.sent().text()];case 2:return[2,e.sent()]}})})},this.loadJson=function(t){return tslib.__awaiter(e,void 0,void 0,function(){return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,o.fetchItem(t)];case 1:return[4,e.sent().json()];case 2:return[2,e.sent()]}})})},this.loadArrayBuffer=function(t){return tslib.__awaiter(e,void 0,void 0,function(){return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,o.fetchItem(t)];case 1:return[4,e.sent().arrayBuffer()];case 2:return[2,e.sent()]}})})},this.loadBlob=function(t){return tslib.__awaiter(e,void 0,void 0,function(){return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,o.fetchItem(t)];case 1:return[4,e.sent().blob()];case 2:return[2,e.sent()]}})})},this.loadFormData=function(t){return tslib.__awaiter(e,void 0,void 0,function(){return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,o.fetchItem(t)];case 1:return[4,e.sent().formData()];case 2:return[2,e.sent()]}})})},this.loadImage=function(t){return tslib.__awaiter(e,void 0,void 0,function(){var n,i;return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,o.fetchItem(t)];case 1:return[4,e.sent()[t.body||this.defaultBodyMethod]()];case 2:return(n=e.sent(),t.body)?[2,n]:(i=new Image,[4,new Promise(function(t,r){i.addEventListener("load",function e(){i.removeEventListener("load",e),t(i)}),i.addEventListener("error",function e(){i.removeEventListener("error",e),r(i)}),i.src=URL.createObjectURL(n)})]);case 3:return[2,e.sent()]}})})},this.loadVideo=function(t){return tslib.__awaiter(e,void 0,void 0,function(){var n,i;return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,o.fetchItem(t)];case 1:return[4,e.sent()[t.body||this.defaultBodyMethod]()];case 2:return(n=e.sent(),t.body)?[2,n]:(i=document.createElement("video"),[4,new Promise(function(t,r){i.addEventListener("canplaythrough",function e(){i.removeEventListener("canplaythrough",e),t(i)}),i.addEventListener("error",function e(){i.removeEventListener("error",e),r(i)});try{if(isSafari)throw"";i.srcObject=n}catch(e){i.src=URL.createObjectURL(n)}i.load()})]);case 3:return[2,e.sent()]}})})},this.loadAudio=function(t){return tslib.__awaiter(e,void 0,void 0,function(){var n,i;return tslib.__generator(this,function(e){switch(e.label){case 0:return[4,o.fetchItem(t)];case 1:return[4,e.sent()[t.body||this.defaultBodyMethod]()];case 2:return(n=e.sent(),t.body)?[2,n]:((i=document.createElement("audio")).autoplay=!1,i.preload="auto",[4,new Promise(function(t,r){i.addEventListener("canplaythrough",function e(){i.removeEventListener("canplaythrough",e),t(i)}),i.addEventListener("error",function e(){i.removeEventListener("error",e),r(i)});try{if(isSafari)throw"";i.srcObject=n}catch(e){i.src=URL.createObjectURL(n)}i.load()})]);case 3:return[2,e.sent()]}})})},this.loadXml=function(n){return tslib.__awaiter(e,void 0,void 0,function(){var t,r;return tslib.__generator(this,function(e){switch(e.label){case 0:return n.mimeType||(t=o.getFileExtension(n.src),n=tslib.__assign(tslib.__assign({},n),{mimeType:o.getMimeType(LoaderKey.Xml,t)})),[4,o.fetchItem(n)];case 1:return[4,e.sent().text()];case 2:return r=e.sent(),[2,o.domParser.parseFromString(r,n.mimeType)]}})})},this.loadFont=function(r){return tslib.__awaiter(e,void 0,void 0,function(){var t;return tslib.__generator(this,function(e){switch(e.label){case 0:return t=r.id,[4,new FontFaceObserver(t,r.options||{}).load()];case 1:return e.sent(),[2,t]}})})}}return o.fetchItem=function(e){return fetch(e.src,e.options||{})},o.getProp=function(e,t){var r=Array.isArray(t)?t:t.split(".").filter(function(e){return e.length});return r.length?o.getProp(e[r.shift()],r):e},o.getFileExtension=function(e){return(e.match(/[^\\/]\.([^.\\/]+)$/)||[null]).pop()},o.getLoaderKey=function(t){var e=Array.from(o.loaders).find(function(e){return e[1].extensions.includes(t)});return e?e[0]:LoaderKey.Text},o.getMimeType=function(e,t){var r=o.loaders.get(e);return r.mimeType[t]||r.defaultMimeType},o.loaders=(new Map).set(LoaderKey.Text,{extensions:["txt"]}).set(LoaderKey.Json,{extensions:["json"]}).set(LoaderKey.Image,{extensions:["jpeg","jpg","gif","png","webp"]}).set(LoaderKey.Video,{extensions:["webm","ogg","mp4"]}).set(LoaderKey.Audio,{extensions:["webm","ogg","mp3","wav","flac"]}).set(LoaderKey.Xml,{extensions:["xml","svg","html"],mimeType:{xml:"text/xml",svg:"image/svg+xml",html:"text/html"},defaultMimeType:"text/xml"}).set(LoaderKey.Font,{extensions:["woff2","woff","ttf","otf","eot"]}),o.domParser=new DOMParser,o}(),AsyncPreloaderInstance=new AsyncPreloader;exports.AsyncPreloader=AsyncPreloader,exports.default=AsyncPreloaderInstance;
